const METALS_DATA = [
    {
        "rank": "1",
        "country": "United States of America",
        "gold": "39",
        "silver": "41",
        "bronze": "33",
        "total": "113",
        "rankTotal": "1"
    },
    {
        "rank": "2",
        "country": "People's Republic of China",
        "gold": "38",
        "silver": "32",
        "bronze": "18",
        "total": "88",
        "rankTotal": "2"
    },
    {
        "rank": "3",
        "country": "Japan",
        "gold": "27",
        "silver": "14",
        "bronze": "17",
        "total": "58",
        "rankTotal": "5"
    },
    {
        "rank": "4",
        "country": "Great Britain",
        "gold": "22",
        "silver": "21",
        "bronze": "22",
        "total": "65",
        "rankTotal": "4"
    },
    {
        "rank": "5",
        "country": "ROC",
        "gold": "20",
        "silver": "28",
        "bronze": "23",
        "total": "71",
        "rankTotal": "3"
    },
    {
        "rank": "6",
        "country": "Australia",
        "gold": "17",
        "silver": "7",
        "bronze": "22",
        "total": "46",
        "rankTotal": "6"
    },
    {
        "rank": "7",
        "country": "Netherlands",
        "gold": "10",
        "silver": "12",
        "bronze": "14",
        "total": "36",
        "rankTotal": "9"
    },
    {
        "rank": "8",
        "country": "France",
        "gold": "10",
        "silver": "12",
        "bronze": "11",
        "total": "33",
        "rankTotal": "10"
    },
    {
        "rank": "9",
        "country": "Germany",
        "gold": "10",
        "silver": "11",
        "bronze": "16",
        "total": "37",
        "rankTotal": "8"
    },
    {
        "rank": "10",
        "country": "Italy",
        "gold": "10",
        "silver": "10",
        "bronze": "20",
        "total": "40",
        "rankTotal": "7"
    },
    {
        "rank": "11",
        "country": "Canada",
        "gold": "7",
        "silver": "6",
        "bronze": "11",
        "total": "24",
        "rankTotal": "11"
    },
    {
        "rank": "12",
        "country": "Brazil",
        "gold": "7",
        "silver": "6",
        "bronze": "8",
        "total": "21",
        "rankTotal": "12"
    },
    {
        "rank": "13",
        "country": "New Zealand",
        "gold": "7",
        "silver": "6",
        "bronze": "7",
        "total": "20",
        "rankTotal": "13"
    },
    {
        "rank": "14",
        "country": "Cuba",
        "gold": "7",
        "silver": "3",
        "bronze": "5",
        "total": "15",
        "rankTotal": "18"
    },
    {
        "rank": "15",
        "country": "Hungary",
        "gold": "6",
        "silver": "7",
        "bronze": "7",
        "total": "20",
        "rankTotal": "13"
    },
    {
        "rank": "16",
        "country": "Republic of Korea",
        "gold": "6",
        "silver": "4",
        "bronze": "10",
        "total": "20",
        "rankTotal": "13"
    },
    {
        "rank": "17",
        "country": "Poland",
        "gold": "4",
        "silver": "5",
        "bronze": "5",
        "total": "14",
        "rankTotal": "19"
    },
    {
        "rank": "18",
        "country": "Czech Republic",
        "gold": "4",
        "silver": "4",
        "bronze": "3",
        "total": "11",
        "rankTotal": "23"
    },
    {
        "rank": "19",
        "country": "Kenya",
        "gold": "4",
        "silver": "4",
        "bronze": "2",
        "total": "10",
        "rankTotal": "25"
    },
    {
        "rank": "20",
        "country": "Norway",
        "gold": "4",
        "silver": "2",
        "bronze": "2",
        "total": "8",
        "rankTotal": "29"
    },
    {
        "rank": "21",
        "country": "Jamaica",
        "gold": "4",
        "silver": "1",
        "bronze": "4",
        "total": "9",
        "rankTotal": "26"
    },
    {
        "rank": "22",
        "country": "Spain",
        "gold": "3",
        "silver": "8",
        "bronze": "6",
        "total": "17",
        "rankTotal": "17"
    },
    {
        "rank": "23",
        "country": "Sweden",
        "gold": "3",
        "silver": "6",
        "bronze": "0",
        "total": "9",
        "rankTotal": "26"
    },
    {
        "rank": "24",
        "country": "Switzerland",
        "gold": "3",
        "silver": "4",
        "bronze": "6",
        "total": "13",
        "rankTotal": "20"
    },
    {
        "rank": "25",
        "country": "Denmark",
        "gold": "3",
        "silver": "4",
        "bronze": "4",
        "total": "11",
        "rankTotal": "23"
    },
    {
        "rank": "26",
        "country": "Croatia",
        "gold": "3",
        "silver": "3",
        "bronze": "2",
        "total": "8",
        "rankTotal": "29"
    },
    {
        "rank": "27",
        "country": "Islamic Republic of Iran",
        "gold": "3",
        "silver": "2",
        "bronze": "2",
        "total": "7",
        "rankTotal": "33"
    },
    {
        "rank": "28",
        "country": "Serbia",
        "gold": "3",
        "silver": "1",
        "bronze": "5",
        "total": "9",
        "rankTotal": "26"
    },
    {
        "rank": "29",
        "country": "Belgium",
        "gold": "3",
        "silver": "1",
        "bronze": "3",
        "total": "7",
        "rankTotal": "33"
    },
    {
        "rank": "30",
        "country": "Bulgaria",
        "gold": "3",
        "silver": "1",
        "bronze": "2",
        "total": "6",
        "rankTotal": "39"
    },
    {
        "rank": "31",
        "country": "Slovenia",
        "gold": "3",
        "silver": "1",
        "bronze": "1",
        "total": "5",
        "rankTotal": "42"
    },
    {
        "rank": "32",
        "country": "Uzbekistan",
        "gold": "3",
        "silver": "0",
        "bronze": "2",
        "total": "5",
        "rankTotal": "42"
    },
    {
        "rank": "33",
        "country": "Georgia",
        "gold": "2",
        "silver": "5",
        "bronze": "1",
        "total": "8",
        "rankTotal": "29"
    },
    {
        "rank": "34",
        "country": "Chinese Taipei",
        "gold": "2",
        "silver": "4",
        "bronze": "6",
        "total": "12",
        "rankTotal": "22"
    },
    {
        "rank": "35",
        "country": "Turkey",
        "gold": "2",
        "silver": "2",
        "bronze": "9",
        "total": "13",
        "rankTotal": "20"
    },
    {
        "rank": "36",
        "country": "Greece",
        "gold": "2",
        "silver": "1",
        "bronze": "1",
        "total": "4",
        "rankTotal": "47"
    },
    {
        "rank": "36",
        "country": "Uganda",
        "gold": "2",
        "silver": "1",
        "bronze": "1",
        "total": "4",
        "rankTotal": "47"
    },
    {
        "rank": "38",
        "country": "Ecuador",
        "gold": "2",
        "silver": "1",
        "bronze": "0",
        "total": "3",
        "rankTotal": "60"
    },
    {
        "rank": "39",
        "country": "Ireland",
        "gold": "2",
        "silver": "0",
        "bronze": "2",
        "total": "4",
        "rankTotal": "47"
    },
    {
        "rank": "39",
        "country": "Israel",
        "gold": "2",
        "silver": "0",
        "bronze": "2",
        "total": "4",
        "rankTotal": "47"
    },
    {
        "rank": "41",
        "country": "Qatar",
        "gold": "2",
        "silver": "0",
        "bronze": "1",
        "total": "3",
        "rankTotal": "60"
    },
    {
        "rank": "42",
        "country": "Bahamas",
        "gold": "2",
        "silver": "0",
        "bronze": "0",
        "total": "2",
        "rankTotal": "66"
    },
    {
        "rank": "42",
        "country": "Kosovo",
        "gold": "2",
        "silver": "0",
        "bronze": "0",
        "total": "2",
        "rankTotal": "66"
    },
    {
        "rank": "44",
        "country": "Ukraine",
        "gold": "1",
        "silver": "6",
        "bronze": "12",
        "total": "19",
        "rankTotal": "16"
    },
    {
        "rank": "45",
        "country": "Belarus",
        "gold": "1",
        "silver": "3",
        "bronze": "3",
        "total": "7",
        "rankTotal": "33"
    },
    {
        "rank": "46",
        "country": "Romania",
        "gold": "1",
        "silver": "3",
        "bronze": "0",
        "total": "4",
        "rankTotal": "47"
    },
    {
        "rank": "46",
        "country": "Venezuela",
        "gold": "1",
        "silver": "3",
        "bronze": "0",
        "total": "4",
        "rankTotal": "47"
    },
    {
        "rank": "48",
        "country": "India",
        "gold": "1",
        "silver": "2",
        "bronze": "4",
        "total": "7",
        "rankTotal": "33"
    },
    {
        "rank": "49",
        "country": "Hong Kong, China",
        "gold": "1",
        "silver": "2",
        "bronze": "3",
        "total": "6",
        "rankTotal": "39"
    },
    {
        "rank": "50",
        "country": "Philippines",
        "gold": "1",
        "silver": "2",
        "bronze": "1",
        "total": "4",
        "rankTotal": "47"
    },
    {
        "rank": "50",
        "country": "Slovakia",
        "gold": "1",
        "silver": "2",
        "bronze": "1",
        "total": "4",
        "rankTotal": "47"
    },
    {
        "rank": "52",
        "country": "South Africa",
        "gold": "1",
        "silver": "2",
        "bronze": "0",
        "total": "3",
        "rankTotal": "60"
    },
    {
        "rank": "53",
        "country": "Austria",
        "gold": "1",
        "silver": "1",
        "bronze": "5",
        "total": "7",
        "rankTotal": "33"
    },
    {
        "rank": "54",
        "country": "Egypt",
        "gold": "1",
        "silver": "1",
        "bronze": "4",
        "total": "6",
        "rankTotal": "39"
    },
    {
        "rank": "55",
        "country": "Indonesia",
        "gold": "1",
        "silver": "1",
        "bronze": "3",
        "total": "5",
        "rankTotal": "42"
    },
    {
        "rank": "56",
        "country": "Ethiopia",
        "gold": "1",
        "silver": "1",
        "bronze": "2",
        "total": "4",
        "rankTotal": "47"
    },
    {
        "rank": "56",
        "country": "Portugal",
        "gold": "1",
        "silver": "1",
        "bronze": "2",
        "total": "4",
        "rankTotal": "47"
    },
    {
        "rank": "58",
        "country": "Tunisia",
        "gold": "1",
        "silver": "1",
        "bronze": "0",
        "total": "2",
        "rankTotal": "66"
    },
    {
        "rank": "59",
        "country": "Estonia",
        "gold": "1",
        "silver": "0",
        "bronze": "1",
        "total": "2",
        "rankTotal": "66"
    },
    {
        "rank": "59",
        "country": "Fiji",
        "gold": "1",
        "silver": "0",
        "bronze": "1",
        "total": "2",
        "rankTotal": "66"
    },
    {
        "rank": "59",
        "country": "Latvia",
        "gold": "1",
        "silver": "0",
        "bronze": "1",
        "total": "2",
        "rankTotal": "66"
    },
    {
        "rank": "59",
        "country": "Thailand",
        "gold": "1",
        "silver": "0",
        "bronze": "1",
        "total": "2",
        "rankTotal": "66"
    },
    {
        "rank": "63",
        "country": "Bermuda",
        "gold": "1",
        "silver": "0",
        "bronze": "0",
        "total": "1",
        "rankTotal": "77"
    },
    {
        "rank": "63",
        "country": "Morocco",
        "gold": "1",
        "silver": "0",
        "bronze": "0",
        "total": "1",
        "rankTotal": "77"
    },
    {
        "rank": "63",
        "country": "Puerto Rico",
        "gold": "1",
        "silver": "0",
        "bronze": "0",
        "total": "1",
        "rankTotal": "77"
    },
    {
        "rank": "66",
        "country": "Colombia",
        "gold": "0",
        "silver": "4",
        "bronze": "1",
        "total": "5",
        "rankTotal": "42"
    },
    {
        "rank": "67",
        "country": "Azerbaijan",
        "gold": "0",
        "silver": "3",
        "bronze": "4",
        "total": "7",
        "rankTotal": "33"
    },
    {
        "rank": "68",
        "country": "Dominican Republic",
        "gold": "0",
        "silver": "3",
        "bronze": "2",
        "total": "5",
        "rankTotal": "42"
    },
    {
        "rank": "69",
        "country": "Armenia",
        "gold": "0",
        "silver": "2",
        "bronze": "2",
        "total": "4",
        "rankTotal": "47"
    },
    {
        "rank": "70",
        "country": "Kyrgyzstan",
        "gold": "0",
        "silver": "2",
        "bronze": "1",
        "total": "3",
        "rankTotal": "60"
    },
    {
        "rank": "71",
        "country": "Mongolia",
        "gold": "0",
        "silver": "1",
        "bronze": "3",
        "total": "4",
        "rankTotal": "47"
    },
    {
        "rank": "72",
        "country": "Argentina",
        "gold": "0",
        "silver": "1",
        "bronze": "2",
        "total": "3",
        "rankTotal": "60"
    },
    {
        "rank": "72",
        "country": "San Marino",
        "gold": "0",
        "silver": "1",
        "bronze": "2",
        "total": "3",
        "rankTotal": "60"
    },
    {
        "rank": "74",
        "country": "Jordan",
        "gold": "0",
        "silver": "1",
        "bronze": "1",
        "total": "2",
        "rankTotal": "66"
    },
    {
        "rank": "74",
        "country": "Malaysia",
        "gold": "0",
        "silver": "1",
        "bronze": "1",
        "total": "2",
        "rankTotal": "66"
    },
    {
        "rank": "74",
        "country": "Nigeria",
        "gold": "0",
        "silver": "1",
        "bronze": "1",
        "total": "2",
        "rankTotal": "66"
    },
    {
        "rank": "77",
        "country": "Bahrain",
        "gold": "0",
        "silver": "1",
        "bronze": "0",
        "total": "1",
        "rankTotal": "77"
    },
    {
        "rank": "77",
        "country": "Saudi Arabia",
        "gold": "0",
        "silver": "1",
        "bronze": "0",
        "total": "1",
        "rankTotal": "77"
    },
    {
        "rank": "77",
        "country": "Lithuania",
        "gold": "0",
        "silver": "1",
        "bronze": "0",
        "total": "1",
        "rankTotal": "77"
    },
    {
        "rank": "77",
        "country": "North Macedonia",
        "gold": "0",
        "silver": "1",
        "bronze": "0",
        "total": "1",
        "rankTotal": "77"
    },
    {
        "rank": "77",
        "country": "Namibia",
        "gold": "0",
        "silver": "1",
        "bronze": "0",
        "total": "1",
        "rankTotal": "77"
    },
    {
        "rank": "77",
        "country": "Turkmenistan",
        "gold": "0",
        "silver": "1",
        "bronze": "0",
        "total": "1",
        "rankTotal": "77"
    },
    {
        "rank": "83",
        "country": "Kazakhstan",
        "gold": "0",
        "silver": "0",
        "bronze": "8",
        "total": "8",
        "rankTotal": "29"
    },
    {
        "rank": "84",
        "country": "Mexico",
        "gold": "0",
        "silver": "0",
        "bronze": "4",
        "total": "4",
        "rankTotal": "47"
    },
    {
        "rank": "85",
        "country": "Finland",
        "gold": "0",
        "silver": "0",
        "bronze": "2",
        "total": "2",
        "rankTotal": "66"
    },
    {
        "rank": "86",
        "country": "Botswana",
        "gold": "0",
        "silver": "0",
        "bronze": "1",
        "total": "1",
        "rankTotal": "77"
    },
    {
        "rank": "86",
        "country": "Burkina Faso",
        "gold": "0",
        "silver": "0",
        "bronze": "1",
        "total": "1",
        "rankTotal": "77"
    },
    {
        "rank": "86",
        "country": "Côte d'Ivoire",
        "gold": "0",
        "silver": "0",
        "bronze": "1",
        "total": "1",
        "rankTotal": "77"
    },
    {
        "rank": "86",
        "country": "Ghana",
        "gold": "0",
        "silver": "0",
        "bronze": "1",
        "total": "1",
        "rankTotal": "77"
    },
    {
        "rank": "86",
        "country": "Grenada",
        "gold": "0",
        "silver": "0",
        "bronze": "1",
        "total": "1",
        "rankTotal": "77"
    },
    {
        "rank": "86",
        "country": "Kuwait",
        "gold": "0",
        "silver": "0",
        "bronze": "1",
        "total": "1",
        "rankTotal": "77"
    },
    {
        "rank": "86",
        "country": "Republic of Moldova",
        "gold": "0",
        "silver": "0",
        "bronze": "1",
        "total": "1",
        "rankTotal": "77"
    },
    {
        "rank": "86",
        "country": "Syrian Arab Republic",
        "gold": "0",
        "silver": "0",
        "bronze": "1",
        "total": "1",
        "rankTotal": "77"
    }
];


medals = ['gold', 'silver', 'bronze'];

countryMedals = medals.flatMap(medal => METALS_DATA.map(d => ({country: d.country, medal, count: d[medal]}))) // pivot longer

chart = StackedBarChart(countryMedals, {
    x: d => d.count,
    y: d => d.country,
    z: d => d.medal,
    yDomain: d3.groupSort(countryMedals, D => d3.sum(D, d => d.count), d => d.country),
    xLabel: " Total Medals Earned →",
    zDomain: medals,
    xDomain: [0,115],
    //colors: d3.schemeSpectral[medals.length],
    colors: ["#ffd700", "#c0c0c0", "#b08d57"],
    width: 1800,
    height: 1000,
    marginLeft:200,
    marginRight:200
})

key = Legend(chart.scales.color, {title: "Medal (color)"});

// Create empty list.
const listItems = d3
    .select('#data')
    .classed('scrollCheckbox', true)
    .select('ul')
    .selectAll('li')
    .data(METALS_DATA)
    .enter()
    .append('li');

// Initialize checklist items.
listItems
    .append('span')
    .text((d)=> d.country)
    .append('input')
    .attr('type', 'checkbox');

// Initialize empty checklist.
let unselectedIds = [];
for (let i = 1; i <= METALS_DATA.length; i++) {
    unselectedIds.push(i.toString());
}

// Add event listener to checklist items.
listItems
    .on('change', (d1) => {
        if (unselectedIds.indexOf(d1.rank) === -1) {
            unselectedIds.push(d1.rank);
        } else {
            unselectedIds = unselectedIds.filter((id) => id !== d1.rank);
        }
        // Update selected data based on current selection.
        selectedData = METALS_DATA.filter((d2) => unselectedIds.indexOf(d2.rank) === -1);
        renderChart();
    });

// Copyright 2021 Observable, Inc.
// Released under the ISC license.
// https://observablehq.com/@d3/stacked-horizontal-bar-chart
function StackedBarChart(data, {
    x = d => d, // given d in data, returns the (quantitative) x-value
    y = (d, i) => i, // given d in data, returns the (ordinal) y-value
    z = () => 1, // given d in data, returns the (categorical) z-value
    title, // given d in data, returns the title text
    marginTop = 30, // top margin, in pixels
    marginRight = 0, // right margin, in pixels
    marginBottom = 0, // bottom margin, in pixels
    marginLeft = 100, // left margin, in pixels
    width = 1000, // outer width, in pixels
    height = 2000, // outer height, in pixels
    xType = d3.scaleLinear, // type of x-scale
    xDomain, // [xmin, xmax]
    xRange = [marginLeft, width - marginRight], // [left, right]
    yDomain, // array of y-values
    yRange, // [bottom, top]
    yPadding = 0.1, // amount of y-range to reserve to separate bars
    zDomain, // array of z-values
    offset = d3.stackOffsetDiverging, // stack offset method
    order = d3.stackOrderNone, // stack order method
    xFormat, // a format specifier string for the x-axis
    xLabel, // a label for the x-axis
    colors = d3.schemeTableau10, // array of colors
} = {}) {
    // Compute values.
    const X = d3.map(data, x);
    const Y = d3.map(data, y);
    const Z = d3.map(data, z);

    // Compute default y- and z-domains, and unique them.
    if (yDomain === undefined) yDomain = Y;
    if (zDomain === undefined) zDomain = Z;
    yDomain = new d3.InternSet(yDomain);
    zDomain = new d3.InternSet(zDomain);

    // Omit any data not present in the y- and z-domains.
    const I = d3.range(X.length).filter(i => yDomain.has(Y[i]) && zDomain.has(Z[i]));

    // If the height is not specified, derive it from the y-domain.
    if (height === undefined) height = yDomain.size * 25 + marginTop + marginBottom;
    if (yRange === undefined) yRange = [height - marginBottom, marginTop];

    // Compute a nested array of series where each series is [[x1, x2], [x1, x2],
    // [x1, x2], …] representing the x-extent of each stacked rect. In addition,
    // each tuple has an i (index) property so that we can refer back to the
    // original data point (data[i]). This code assumes that there is only one
    // data point for a given unique y- and z-value.
    const series = d3.stack()
        .keys(zDomain)
        .value(([, I], z) => X[I.get(z)])
        .order(order)
        .offset(offset)
        (d3.rollup(I, ([i]) => i, i => Y[i], i => Z[i]))
        .map(s => s.map(d => Object.assign(d, {i: d.data[1].get(s.key)})));

    // Compute the default y-domain. Note: diverging stacks can be negative.
    if (xDomain === undefined) xDomain = d3.extent(series.flat(2));

    // Construct scales, axes, and formats.
    const xScale = xType(xDomain, xRange);
    const yScale = d3.scaleBand(yDomain, yRange).paddingInner(yPadding);
    const color = d3.scaleOrdinal(zDomain, colors);
    const xAxis = d3.axisTop(xScale).ticks(width / 80, xFormat);
    const yAxis = d3.axisLeft(yScale).tickSizeOuter(0);

    // Compute titles.
    if (title === undefined) {
        const formatValue = xScale.tickFormat(100, xFormat);
        title = i => `${Y[i]}\n${Z[i]}\n${formatValue(X[i])}`;
    } else {
        const O = d3.map(data, d => d);
        const T = title;
        title = i => T(O[i], i, data);
    }

    const svg = d3
        .select("#chart")
        .select("svg")
        .attr("width", width)
        .attr("height", height)
        .attr("viewBox", [0, 0, width, height])
        .attr("style", "max-width: 100%; height: auto; height: intrinsic;");

    svg.append("g")
        .attr("transform", `translate(0,${marginTop})`)
        .call(xAxis)
        .call(g => g.select(".domain").remove())
        .call(g => g.selectAll(".tick line").clone()
            .attr("y2", height - marginTop - marginBottom)
            .attr("stroke-opacity", 0.1))
        .call(g => g.append("text")
            .attr("x", width - marginRight)
            .attr("y", -22)
            .attr("fill", "currentColor")
            .attr("text-anchor", "end")
            .text(xLabel));

    const bar = svg.append("g")
        .selectAll("g")
        .data(series)
        .join("g")
        .attr("fill", ([{i}]) => color(Z[i]))
        .selectAll("rect")
        .data(d => d)
        .join("rect")
        .attr("x", ([x1, x2]) => Math.min(xScale(x1), xScale(x2)))
        .attr("y", ({i}) => yScale(Y[i]))
        .attr("width", ([x1, x2]) => Math.abs(xScale(x1) - xScale(x2)))
        .attr("height", yScale.bandwidth());

    if (title) bar.append("title")
        .text(({i}) => title(i));

    svg.append("g")
        .attr("transform", `translate(${xScale(0)},0)`)
        .call(yAxis);

    return Object.assign(svg.node(), {scales: {color}});
}

// Copyright 2021, Observable Inc.
// Released under the ISC license.
// https://observablehq.com/@d3/color-legend
function Legend(color, {
    title,
    tickSize = 6,
    width = 100,
    height = 44 + tickSize,
    marginTop = 18,
    marginRight = 0,
    marginBottom = 16 + tickSize,
    marginLeft = 0,
    ticks = width / 64,
    tickFormat,
    tickValues
} = {}) {

    function ramp(color, n = 256) {
        const canvas = document.createElement("canvas");
        canvas.width = n;
        canvas.height = 1;
        const context = canvas.getContext("2d");
        for (let i = 0; i < n; ++i) {
            context.fillStyle = color(i / (n - 1));
            context.fillRect(i, 0, 1, 1);
        }
        return canvas;
    }

    const svg = d3
        .select('#legend')
        .select('svg')
        .attr("width", width)
        .attr("height", height)
        .attr("viewBox", [0, 0, width, height])
        .style("overflow", "visible")
        .style("display", "block");

    let tickAdjust = g => g.selectAll(".tick line").attr("y1", marginTop + marginBottom - height);
    let x;

    // Continuous
    if (color.interpolate) {
        const n = Math.min(color.domain().length, color.range().length);

        x = color.copy().rangeRound(d3.quantize(d3.interpolate(marginLeft, width - marginRight), n));

        svg.append("image")
            .attr("x", marginLeft)
            .attr("y", marginTop)
            .attr("width", width - marginLeft - marginRight)
            .attr("height", height - marginTop - marginBottom)
            .attr("preserveAspectRatio", "none")
            .attr("xlink:href", ramp(color.copy().domain(d3.quantize(d3.interpolate(0, 1), n))).toDataURL());
    }

    // Sequential
    else if (color.interpolator) {
        x = Object.assign(color.copy()
                .interpolator(d3.interpolateRound(marginLeft, width - marginRight)),
            {range() { return [marginLeft, width - marginRight]; }});

        svg.append("image")
            .attr("x", marginLeft)
            .attr("y", marginTop)
            .attr("width", width - marginLeft - marginRight)
            .attr("height", height - marginTop - marginBottom)
            .attr("preserveAspectRatio", "none")
            .attr("xlink:href", ramp(color.interpolator()).toDataURL());

        // scaleSequentialQuantile doesn’t implement ticks or tickFormat.
        if (!x.ticks) {
            if (tickValues === undefined) {
                const n = Math.round(ticks + 1);
                tickValues = d3.range(n).map(i => d3.quantile(color.domain(), i / (n - 1)));
            }
            if (typeof tickFormat !== "function") {
                tickFormat = d3.format(tickFormat === undefined ? ",f" : tickFormat);
            }
        }
    }

    // Threshold
    else if (color.invertExtent) {
        const thresholds
            = color.thresholds ? color.thresholds() // scaleQuantize
            : color.quantiles ? color.quantiles() // scaleQuantile
                : color.domain(); // scaleThreshold

        const thresholdFormat
            = tickFormat === undefined ? d => d
            : typeof tickFormat === "string" ? d3.format(tickFormat)
                : tickFormat;

        x = d3.scaleLinear()
            .domain([-1, color.range().length - 1])
            .rangeRound([marginLeft, width - marginRight]);

        svg.append("g")
            .selectAll("rect")
            .data(color.range())
            .join("rect")
            .attr("x", (d, i) => x(i - 1))
            .attr("y", marginTop)
            .attr("width", (d, i) => x(i) - x(i - 1))
            .attr("height", height - marginTop - marginBottom)
            .attr("fill", d => d);

        tickValues = d3.range(thresholds.length);
        tickFormat = i => thresholdFormat(thresholds[i], i);
    }

    // Ordinal
    else {
        x = d3.scaleBand()
            .domain(color.domain())
            .rangeRound([marginLeft, width - marginRight]);

        svg.append("g")
            .selectAll("rect")
            .data(color.domain())
            .join("rect")
            .attr("x", x)
            .attr("y", marginTop)
            .attr("width", Math.max(0, x.bandwidth() - 1))
            .attr("height", height - marginTop - marginBottom)
            .attr("fill", color);

        tickAdjust = () => {};
    }

    svg.append("g")
        .attr("transform", `translate(0,${height - marginBottom})`)
        .call(d3.axisBottom(x)
            .ticks(ticks, typeof tickFormat === "string" ? tickFormat : undefined)
            .tickFormat(typeof tickFormat === "function" ? tickFormat : undefined)
            .tickSize(tickSize)
            .tickValues(tickValues))
        .call(tickAdjust)
        .call(g => g.select(".domain").remove())
        .call(g => g.append("text")
            .attr("x", marginLeft)
            .attr("y", marginTop + marginBottom - height - 6)
            .attr("fill", "currentColor")
            .attr("text-anchor", "start")
            .attr("font-weight", "bold")
            .attr("class", "title")
            .text(title));

    return svg.node();
}